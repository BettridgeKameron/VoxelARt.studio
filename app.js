import*as e from"three";import{OrbitControls as t}from"three/addons/controls/OrbitControls.js";import{ARButton as r}from"three/addons/webxr/ARButton.js";class VoxelWorld{constructor(e){this.cellSize=e.cellSize;let{cellSize:t}=this;this.cellSliceSize=t*t,this.cells={}}computeVoxelOffset(t,r,l){let{cellSize:o,cellSliceSize:i}=this,n=0|e.MathUtils.euclideanModulo(t,o),s=0|e.MathUtils.euclideanModulo(r,o),a=0|e.MathUtils.euclideanModulo(l,o);return s*i+a*o+n}computeCellId(e,t,r){let{cellSize:l}=this;return`${Math.floor(e/l)},${Math.floor(t/l)},${Math.floor(r/l)}`}addCellForVoxel(e,t,r){let l=this.computeCellId(e,t,r),o=this.cells[l];if(!o){let{cellSize:i}=this;o=new Uint8Array(i*i*i),this.cells[l]=o}return o}getCellForVoxel(e,t,r){return this.cells[this.computeCellId(e,t,r)]}setVoxel(e,t,r,l,o=!0){let i=this.getCellForVoxel(e,t,r);if(!i){if(!o)return;i=this.addCellForVoxel(e,t,r)}let n=this.computeVoxelOffset(e,t,r);i[n]=l}getVoxel(e,t,r){let l=this.getCellForVoxel(e,t,r);if(!l)return 0;let o=this.computeVoxelOffset(e,t,r);return l[o]}generateGeometryDataForCell(t,r,l){let{cellSize:o}=this,i=[],n=[],s=[],a=[],$=t*o,d=r*o,c=l*o;for(let f=0;f<o;++f){let u=d+f;for(let _=0;_<o;++_){let h=c+_;for(let m=0;m<o;++m){let x=$+m,p=this.getVoxel(x,u,h);if(p){let g=[0,16777215,0,16711680,16733440,16755200,16776960,65280,65535,22015,255,16711935],w=p%g.length,v=new e.Color(g[w]);for(let{dir:b,corners:y}of VoxelWorld.faces){let S=this.getVoxel(x+b[0],u+b[1],h+b[2]);if(!S){let z=i.length/3;for(let L of y)i.push(L[0]+m,L[1]+f,L[2]+_),n.push(...b),a.push(v.r,v.g,v.b);s.push(z,z+1,z+2,z+2,z+1,z+3)}}}}}}return{positions:i,normals:n,colors:a,indices:s}}intersectRay(e,t){let r=t.x-e.x,l=t.y-e.y,o=t.z-e.z,i=r*r+l*l+o*o,n=Math.sqrt(i);r/=n,l/=n,o/=n;let s=0,a=Math.floor(e.x),$=Math.floor(e.y),d=Math.floor(e.z),c=r>0?1:-1,f=l>0?1:-1,u=o>0?1:-1,_=Math.abs(1/r),h=Math.abs(1/l),m=Math.abs(1/o),x=c>0?a+1-e.x:e.x-a,p=f>0?$+1-e.y:e.y-$,g=u>0?d+1-e.z:e.z-d,w=_<1/0?_*x:1/0,v=h<1/0?h*p:1/0,b=m<1/0?m*g:1/0,y=-1;for(;s<=n;){let S=this.getVoxel(a,$,d);if(S)return{position:[e.x+s*r,e.y+s*l,e.z+s*o,],normal:[0===y?-c:0,1===y?-f:0,2===y?-u:0,],voxel:S};w<v?w<b?(a+=c,s=w,w+=_,y=0):(d+=u,s=b,b+=m,y=2):v<b?($+=f,s=v,v+=h,y=1):(d+=u,s=b,b+=m,y=2)}return null}serialize(){let e=Object.entries(this.cells).map(([e,t])=>({key:e,value:Array.from(t)}));return JSON.stringify({cellSize:this.cellSize,cells:e})}deserialize(e){let t=JSON.parse(e);this.cellSize=t.cellSize,this.cells=t.cells.reduce((e,{key:t,value:r})=>(e[t]=new Uint8Array(r),e),{})}}VoxelWorld.faces=[{dir:[-1,0,0],corners:[[0,1,0],[0,0,0],[0,1,1],[0,0,1],]},{dir:[1,0,0],corners:[[1,1,1],[1,0,1],[1,1,0],[1,0,0],]},{dir:[0,-1,0],corners:[[1,0,1],[0,0,1],[1,0,0],[0,0,0],]},{dir:[0,1,0],corners:[[0,1,1],[1,1,1],[0,1,0],[1,1,0],]},{dir:[0,0,-1],corners:[[1,0,0],[0,0,0],[1,1,0],[0,1,0],]},{dir:[0,0,1],corners:[[0,0,1],[1,0,1],[0,1,1],[1,1,1],]},];class Reticle extends e.Mesh{constructor(){super(new e.RingBufferGeometry(.1,.12,32).rotateX(-Math.PI/2),new e.MeshStandardMaterial({color:65280,emissive:65280,emissiveIntensity:.5,metalness:.1,roughness:.75,side:e.DoubleSide})),this.matrixAutoUpdate=!1,this.visible=!1}}function placeVoxelArtAtReticle(t,r,l){let{positions:o,normals:i,colors:n,indices:s}=l.generateGeometryDataForCell(0,0,0),a=new e.BufferGeometry;a.setAttribute("position",new e.BufferAttribute(new Float32Array(o),3)),a.setAttribute("normal",new e.BufferAttribute(new Float32Array(i),3)),a.setAttribute("color",new e.BufferAttribute(new Float32Array(n),3)),a.setIndex(s),a.computeBoundingBox();let $=new e.MeshLambertMaterial({vertexColors:!0,side:e.DoubleSide}),d=new e.Mesh(a,$);d.scale.set(.01,.01,.01);let c=-(.01*a.boundingBox.min.y),f=-.005*(a.boundingBox.max.x-a.boundingBox.min.x),u=-.005*(a.boundingBox.max.z-a.boundingBox.min.z);d.position.setFromMatrixPosition(t.matrix),d.position.y+=c,d.position.x+=f,d.position.z+=u,d.quaternion.setFromRotationMatrix(t.matrix),r.add(d)}function clearScene(e){let t=new Set(["Light","DirectionalLight","AmbientLight","Reticle"]);for(let r=e.children.length-1;r>=0;r--){let l=e.children[r];t.has(l.constructor.name)||e.remove(l)}}async function setupARButton(e,t,l){let o=r.createButton(e,{requiredFeatures:["hit-test"]}),i=document.getElementById("arButtonCustom");await navigator.xr.isSessionSupported("immersive-ar")&&(i.textContent="Enter AR",i.className="btn btn-success",i.disabled=!1,i.addEventListener("click",()=>{document.body.appendChild(o),o.click()}));let n;e.xr.addEventListener("sessionstart",async()=>{let r=e.xr.getSession();clearScene(n=t.clone()),n.background=null;let o=new Reticle;n.add(o);let i=!1,s=await r.requestReferenceSpace("viewer"),a=await r.requestHitTestSource({space:s});e.setAnimationLoop(()=>{let t=e.xr.getFrame();if(t){let r=t.getHitTestResults(a);if(r.length>0){let s=r[0],$=s.getPose(e.xr.getReferenceSpace());$&&(o.visible=!i,o.matrix.fromArray($.transform.matrix))}else o.visible=!1}e.render(n,l)}),r.addEventListener("select",()=>{o.visible&&!i&&(placeVoxelArtAtReticle(o,n,world),i=!0,o.visible=!1)})}),e.xr.addEventListener("sessionend",()=>{document.getElementById("ARButton").remove(),e.setAnimationLoop(null),n.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}),e.render(t,l)})}let world;function main(){let r=document.querySelector("#c"),l=new e.WebGLRenderer({antialias:!0,canvas:r,alpha:!0});l.xr.enabled=!0;let o=new e.PerspectiveCamera(75,2,.1,1e3);o.position.set(-9.6,25.6,-9.6);let i=new t(o,r);i.target.set(16,32/3,16),i.update();let n=new e.Scene;function s(t,r,l,o,i,s){let a=new e.DirectionalLight(16777215,.45);a.position.set(t,r,l),a.target.position.set(o,i,s),n.add(a),n.add(a.target)}n.background=new e.Color("lightgrey"),s(-1,32,4,0,16,0),s(1,32,-2,0,16,0),!function t(){let r=new e.AmbientLight(16777215,.35);n.add(r)}(),world=new VoxelWorld({cellSize:32});let a=new e.MeshLambertMaterial({vertexColors:!0,side:e.DoubleSide,transparent:!1}),$={};function d(t,r,l){let o=Math.floor(t/32),i=Math.floor(r/32),s=Math.floor(l/32),d=world.computeCellId(t,r,l),c=$[d],f=c?c.geometry:new e.BufferGeometry,{positions:u,normals:_,colors:h,indices:m}=world.generateGeometryDataForCell(o,i,s);f.setAttribute("position",new e.BufferAttribute(new Float32Array(u),3)),f.setAttribute("normal",new e.BufferAttribute(new Float32Array(_),3)),f.setAttribute("color",new e.BufferAttribute(new Float32Array(h),3)),f.setIndex(m),f.computeBoundingSphere(),c||((c=new e.Mesh(f,a)).name=d,$[d]=c,n.add(c),c.position.set(32*o,32*i,32*s))}let c=[[0,0,0],[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]];function f(e,t,r){let l={};for(let o of c){let i=e+o[0],n=t+o[1],s=r+o[2],a=world.computeCellId(i,n,s);l[a]||(l[a]=!0,d(i,n,s))}}function u(){for(let e=0;e<32;++e)for(let t=0;t<32;++t)world.setVoxel(t,0,e,1);f(1,1,1)}function _(){Object.keys(world.cells).forEach(e=>{let[t,r,l]=e.split(",").map(Number);d(t*world.cellSize,r*world.cellSize,l*world.cellSize)})}function h(){let e=world.serialize();localStorage.setItem("worldData",e)}!function e(){if(location.hash){let t=location.hash.substring(1);try{let r=atob(decodeURIComponent(t)),l=pako.inflate(r,{to:"string"});world.deserialize(l),_(),console.log("World loaded from URL hash."),localStorage.setItem("worldData",l),history.pushState("",document.title,location.pathname+location.search)}catch(o){console.error("Failed to load world from hash",o)}}else{let i=localStorage.getItem("worldData");i?(world.deserialize(i),_(),console.log("World loaded from local storage.")):u()}}(),window.resetWorld=function e(){Object.keys(world.cells).forEach(e=>{let t=world.cells[e];t.fill(0)}),Object.keys(world.cells).forEach(e=>{let[t,r,l]=e.split(",").map(Number);d(t*world.cellSize,r*world.cellSize,l*world.cellSize)}),u(),h(),console.log("World has been reset to initial state.")},document.querySelectorAll("#ui .tiles input[type=radio][name=voxel]").forEach(e=>{e.addEventListener("change",function(){this.checked&&h()})}),window.addEventListener("beforeunload",h);let m=!1;function x(){if(m=void 0,function e(t){let r=t.domElement,l=r.clientWidth,o=r.clientHeight,i=r.width!==l||r.height!==o;return i&&t.setSize(l,o,!1),i}(l)){let e=l.domElement;o.aspect=e.clientWidth/e.clientHeight,o.updateProjectionMatrix()}i.update(),l.render(n,o)}function p(){m||(m=!0,requestAnimationFrame(x))}x();let g=-1,w;function v(){this.id===w?(this.checked=!1,w=void 0,g=-1):(w=this.id,g=parseInt(this.value))}document.querySelectorAll("#ui .tiles input[type=radio][name=voxel]").forEach(e=>{e.addEventListener("click",v)});let b={x:0,y:0};function y(e){b.moveX+=Math.abs(b.x-e.clientX),b.moveY+=Math.abs(b.y-e.clientY)}function S(t){b.moveX<5&&b.moveY<5&&function t(l){if(-1===g)return;let i=function e(t){let l=r.getBoundingClientRect();return{x:(t.clientX-l.left)*r.width/l.width,y:(t.clientY-l.top)*r.height/l.height}}(l),n=i.x/r.width*2-1,s=-(i.y/r.height*2)+1,a=new e.Vector3,$=new e.Vector3;a.setFromMatrixPosition(o.matrixWorld),$.set(n,s,1).unproject(o);let d=world.intersectRay(a,$);if(d){let c=l.shiftKey?0:g,u=d.position.map((e,t)=>e+d.normal[t]*(c>0?.5:-.5));world.setVoxel(...u,c),f(...u),p()}}(t),window.removeEventListener("pointermove",y),window.removeEventListener("pointerup",S)}r.addEventListener("pointerdown",e=>{var t;e.preventDefault(),t=e,b.x=t.clientX,b.y=t.clientY,b.moveX=0,b.moveY=0,window.addEventListener("pointermove",y),window.addEventListener("pointerup",S)},{passive:!1}),r.addEventListener("touchstart",e=>{e.preventDefault()},{passive:!1}),i.addEventListener("change",p),window.addEventListener("resize",p),l.setAnimationLoop(()=>{l.render(n,o)}),setupARButton(l,n,o)}function serializeToBase64(){let e=world.serialize(),t=pako.deflate(e,{to:"string"});return encodeURIComponent(btoa(t))}function getShareURL(){return`${location.origin}${location.pathname}#${serializeToBase64()}`}function exportWorldQRCode(){if(!world){console.error("World is not initialized.");return}let e=getShareURL();QRCode.toCanvas(document.getElementById("qrCanvas"),e,function(e){e?console.error("QR Code Error: ",e):console.log("QR code successfully generated!")})}window.exportWorldQRCode=exportWorldQRCode,window.getShareURL=getShareURL,main();