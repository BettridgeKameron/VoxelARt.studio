import*as e from"three";import{OrbitControls as t}from"three/addons/controls/OrbitControls.js";import{ARButton as r}from"three/addons/webxr/ARButton.js";class VoxelWorld{constructor(e){this.cellSize=e.cellSize;let{cellSize:t}=this;this.cellSliceSize=t*t,this.cells={}}computeVoxelOffset(t,r,o){let{cellSize:i,cellSliceSize:l}=this,n=0|e.MathUtils.euclideanModulo(t,i),s=0|e.MathUtils.euclideanModulo(r,i),$=0|e.MathUtils.euclideanModulo(o,i);return s*l+$*i+n}computeCellId(e,t,r){let{cellSize:o}=this;return`${Math.floor(e/o)},${Math.floor(t/o)},${Math.floor(r/o)}`}addCellForVoxel(e,t,r){let o=this.computeCellId(e,t,r),i=this.cells[o];if(!i){let{cellSize:l}=this;i=new Uint8Array(l*l*l),this.cells[o]=i}return i}getCellForVoxel(e,t,r){return this.cells[this.computeCellId(e,t,r)]}setVoxel(e,t,r,o,i=!0){let l=this.getCellForVoxel(e,t,r);if(!l){if(!i)return;l=this.addCellForVoxel(e,t,r)}let n=this.computeVoxelOffset(e,t,r);l[n]=o}getVoxel(e,t,r){let o=this.getCellForVoxel(e,t,r);if(!o)return 0;let i=this.computeVoxelOffset(e,t,r);return o[i]}generateGeometryDataForCell(t,r,o){let{cellSize:i}=this,l=[],n=[],s=[],$=[],a=t*i,d=r*i,c=o*i;for(let f=0;f<i;++f){let u=d+f;for(let _=0;_<i;++_){let h=c+_;for(let m=0;m<i;++m){let x=a+m,p=this.getVoxel(x,u,h);if(p){let g=[0,16777215,0,16711680,16733440,16755200,16776960,65280,65535,22015,255,16711935],w=p%g.length,v=new e.Color(g[w]);for(let{dir:b,corners:y}of VoxelWorld.faces){let S=this.getVoxel(x+b[0],u+b[1],h+b[2]);if(!S){let z=l.length/3;for(let A of y)l.push(A[0]+m,A[1]+f,A[2]+_),n.push(...b),$.push(v.r,v.g,v.b);s.push(z,z+1,z+2,z+2,z+1,z+3)}}}}}}return{positions:l,normals:n,colors:$,indices:s}}intersectRay(e,t){let r=t.x-e.x,o=t.y-e.y,i=t.z-e.z,l=r*r+o*o+i*i,n=Math.sqrt(l);r/=n,o/=n,i/=n;let s=0,$=Math.floor(e.x),a=Math.floor(e.y),d=Math.floor(e.z),c=r>0?1:-1,f=o>0?1:-1,u=i>0?1:-1,_=Math.abs(1/r),h=Math.abs(1/o),m=Math.abs(1/i),x=c>0?$+1-e.x:e.x-$,p=f>0?a+1-e.y:e.y-a,g=u>0?d+1-e.z:e.z-d,w=_<1/0?_*x:1/0,v=h<1/0?h*p:1/0,b=m<1/0?m*g:1/0,y=-1;for(;s<=n;){let S=this.getVoxel($,a,d);if(S)return{position:[e.x+s*r,e.y+s*o,e.z+s*i,],normal:[0===y?-c:0,1===y?-f:0,2===y?-u:0,],voxel:S};w<v?w<b?($+=c,s=w,w+=_,y=0):(d+=u,s=b,b+=m,y=2):v<b?(a+=f,s=v,v+=h,y=1):(d+=u,s=b,b+=m,y=2)}return null}serialize(){let e=Object.entries(this.cells).map(([e,t])=>({key:e,value:Array.from(t)}));return JSON.stringify({cellSize:this.cellSize,cells:e})}deserialize(e){let t=JSON.parse(e);this.cellSize=t.cellSize,this.cells=t.cells.reduce((e,{key:t,value:r})=>(e[t]=new Uint8Array(r),e),{})}}VoxelWorld.faces=[{dir:[-1,0,0],corners:[[0,1,0],[0,0,0],[0,1,1],[0,0,1],]},{dir:[1,0,0],corners:[[1,1,1],[1,0,1],[1,1,0],[1,0,0],]},{dir:[0,-1,0],corners:[[1,0,1],[0,0,1],[1,0,0],[0,0,0],]},{dir:[0,1,0],corners:[[0,1,1],[1,1,1],[0,1,0],[1,1,0],]},{dir:[0,0,-1],corners:[[1,0,0],[0,0,0],[1,1,0],[0,1,0],]},{dir:[0,0,1],corners:[[0,0,1],[1,0,1],[0,1,1],[1,1,1],]},];class Reticle extends e.Mesh{constructor(){super(new e.RingBufferGeometry(.1,.12,32).rotateX(-Math.PI/2),new e.MeshStandardMaterial({color:65280,emissive:65280,emissiveIntensity:.5,metalness:.1,roughness:.75,side:e.DoubleSide})),this.matrixAutoUpdate=!1,this.visible=!1}}function placeVoxelArtAtReticle(t,r,o){let{positions:i,normals:l,colors:n,indices:s}=o.generateGeometryDataForCell(0,0,0),$=new e.BufferGeometry;$.setAttribute("position",new e.BufferAttribute(new Float32Array(i),3)),$.setAttribute("normal",new e.BufferAttribute(new Float32Array(l),3)),$.setAttribute("color",new e.BufferAttribute(new Float32Array(n),3)),$.setIndex(s),$.computeBoundingBox();let a=new e.MeshLambertMaterial({vertexColors:!0,side:e.DoubleSide}),d=new e.Mesh($,a);d.scale.set(.01,.01,.01);let c=-(.01*$.boundingBox.min.y),f=-.005*($.boundingBox.max.x-$.boundingBox.min.x),u=-.005*($.boundingBox.max.z-$.boundingBox.min.z);d.position.setFromMatrixPosition(t.matrix),d.position.y+=c,d.position.x+=f,d.position.z+=u,d.quaternion.setFromRotationMatrix(t.matrix),r.add(d)}function clearScene(e){let t=new Set(["Light","DirectionalLight","AmbientLight","Reticle"]);for(let r=e.children.length-1;r>=0;r--){let o=e.children[r];t.has(o.constructor.name)||e.remove(o)}}async function setupARButton(e,t,o){let i=r.createButton(e,{requiredFeatures:["hit-test"]}),l=document.getElementById("arButtonCustom");await navigator.xr.isSessionSupported("immersive-ar")&&(l.textContent="Enter AR",l.className="btn btn-success",l.disabled=!1,l.addEventListener("click",()=>{document.body.appendChild(i),i.click()}));let n;e.xr.addEventListener("sessionstart",async()=>{let r=e.xr.getSession();clearScene(n=t.clone()),n.background=null;let i=new Reticle;n.add(i);let l=!1,s=await r.requestReferenceSpace("viewer"),$=await r.requestHitTestSource({space:s});e.setAnimationLoop(()=>{let t=e.xr.getFrame();if(t){let r=t.getHitTestResults($);if(r.length>0){let s=r[0],a=s.getPose(e.xr.getReferenceSpace());a&&(i.visible=!l,i.matrix.fromArray(a.transform.matrix))}else i.visible=!1}e.render(n,o)}),r.addEventListener("select",()=>{i.visible&&!l&&(placeVoxelArtAtReticle(i,n,world),l=!0,i.visible=!1)})}),e.xr.addEventListener("sessionend",()=>{document.getElementById("ARButton").remove(),e.setAnimationLoop(null),n.traverse(e=>{e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()}),e.render(t,o)})}let world;function main(){let r=document.querySelector("#c"),o=new e.WebGLRenderer({antialias:!0,canvas:r,alpha:!0});o.xr.enabled=!0;let i=new e.PerspectiveCamera(75,2,.1,1e3);i.position.set(-9.6,25.6,-9.6);let l=new t(i,r);l.target.set(16,32/3,16),l.update();let n=new e.Scene;function s(t,r,o,i,l,s){let $=new e.DirectionalLight(16777215,.45);$.position.set(t,r,o),$.target.position.set(i,l,s),n.add($),n.add($.target)}n.background=new e.Color("lightgrey"),s(-1,32,4,0,16,0),s(1,32,-2,0,16,0),!function t(){let r=new e.AmbientLight(16777215,.35);n.add(r)}(),world=new VoxelWorld({cellSize:32});let $=new e.MeshLambertMaterial({vertexColors:!0,side:e.DoubleSide,transparent:!1}),a={};function d(t,r,o){let i=Math.floor(t/32),l=Math.floor(r/32),s=Math.floor(o/32),d=world.computeCellId(t,r,o),c=a[d],f=c?c.geometry:new e.BufferGeometry,{positions:u,normals:_,colors:h,indices:m}=world.generateGeometryDataForCell(i,l,s);f.setAttribute("position",new e.BufferAttribute(new Float32Array(u),3)),f.setAttribute("normal",new e.BufferAttribute(new Float32Array(_),3)),f.setAttribute("color",new e.BufferAttribute(new Float32Array(h),3)),f.setIndex(m),f.computeBoundingSphere(),c||((c=new e.Mesh(f,$)).name=d,a[d]=c,n.add(c),c.position.set(32*i,32*l,32*s))}let c=[[0,0,0],[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]];function f(e,t,r){let o={};for(let i of c){let l=e+i[0],n=t+i[1],s=r+i[2],$=world.computeCellId(l,n,s);o[$]||(o[$]=!0,d(l,n,s))}}!function e(){if(location.hash){let t=location.hash.substring(1);try{let r=atob(decodeURIComponent(t)),o=pako.inflate(r,{to:"string"});world.deserialize(o),Object.keys(world.cells).forEach(e=>{let[t,r,o]=e.split(",").map(Number);d(t*world.cellSize,r*world.cellSize,o*world.cellSize)}),console.log("World loaded from URL hash.");return}catch(i){console.error("Failed to load world from hash",i)}}for(let l=0;l<32;++l)for(let n=0;n<32;++n)world.setVoxel(n,0,l,1);f(1,1,1)}();let u=!1;function _(){if(u=void 0,function e(t){let r=t.domElement,o=r.clientWidth,i=r.clientHeight,l=r.width!==o||r.height!==i;return l&&t.setSize(o,i,!1),l}(o)){let e=o.domElement;i.aspect=e.clientWidth/e.clientHeight,i.updateProjectionMatrix()}l.update(),o.render(n,i)}function h(){u||(u=!0,requestAnimationFrame(_))}_();let m=-1,x;function p(){this.id===x?(this.checked=!1,x=void 0,m=-1):(x=this.id,m=parseInt(this.value))}document.querySelectorAll("#ui .tiles input[type=radio][name=voxel]").forEach(e=>{e.addEventListener("click",p)});let g={x:0,y:0};function w(e){g.moveX+=Math.abs(g.x-e.clientX),g.moveY+=Math.abs(g.y-e.clientY)}function v(t){g.moveX<5&&g.moveY<5&&function t(o){if(-1===m)return;let l=function e(t){let o=r.getBoundingClientRect();return{x:(t.clientX-o.left)*r.width/o.width,y:(t.clientY-o.top)*r.height/o.height}}(o),n=l.x/r.width*2-1,s=-(l.y/r.height*2)+1,$=new e.Vector3,a=new e.Vector3;$.setFromMatrixPosition(i.matrixWorld),a.set(n,s,1).unproject(i);let d=world.intersectRay($,a);if(d){let c=o.shiftKey?0:m,u=d.position.map((e,t)=>e+d.normal[t]*(c>0?.5:-.5));world.setVoxel(...u,c),f(...u),h()}}(t),window.removeEventListener("pointermove",w),window.removeEventListener("pointerup",v)}r.addEventListener("pointerdown",e=>{var t;e.preventDefault(),t=e,g.x=t.clientX,g.y=t.clientY,g.moveX=0,g.moveY=0,window.addEventListener("pointermove",w),window.addEventListener("pointerup",v)},{passive:!1}),r.addEventListener("touchstart",e=>{e.preventDefault()},{passive:!1}),l.addEventListener("change",h),window.addEventListener("resize",h),o.setAnimationLoop(()=>{o.render(n,i)}),setupARButton(o,n,i)}function serializeToBase64(){let e=world.serialize(),t=pako.deflate(e,{to:"string"});return encodeURIComponent(btoa(t))}function getShareURL(){return`${location.origin}${location.pathname}#${serializeToBase64()}`}function exportWorldQRCode(){if(!world){console.error("World is not initialized.");return}let e=getShareURL();QRCode.toCanvas(document.getElementById("qrCanvas"),e,function(e){e?console.error("QR Code Error: ",e):console.log("QR code successfully generated!")})}window.exportWorldQRCode=exportWorldQRCode,window.getShareURL=getShareURL,main();